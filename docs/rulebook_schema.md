# Схема Правил (Rulebook Schema) v1.0

Этот документ описывает структуру JSON-объекта, который хранится в поле `metadata` модели `GameSystem`. Он определяет все вычисляемые параметры и специфические для системы правила.

## Корневая структура

Объект `metadata` должен содержать один ключ верхнего уровня: `character_sheet_schema`.

```json
{
  "character_sheet_schema": {
    // ... здесь будут описаны правила для листа персонажа ...
  }
}
```

Этот объект описывает все правила, связанные со структурой и механикой листа персонажа.

### Вычисляемые параметры (`computed_stats`)

Это объект, где каждый ключ — это имя параметра в `character.stats`, который должен быть вычислен автоматически. Значение — это объект, описывающий правило вычисления.

**Структура объекта правила:**

*   `formula` (string, обязательный): Строка, содержащая математическую формулу для вычисления значения.
*   `depends_on` (array of strings, обязательный): Массив, перечисляющий "источники данных", от которых зависит формула. Это помогает движку понять, когда нужно запускать пересчет. Возможные значения: `'level'`, `'stats'`, `'traits'`, `'equipment'`.

**Пример:**

```json
"computed_stats": {
  "max_hp": {
    "formula": "trait_meta('Class', 'base_hp') + stat('level')",
    "depends_on": ["traits", "stats"]
  },
  "evasion": {
    "formula": "trait_meta('Class', 'base_evasion') + equipment_meta('armor', 'evasion_penalty')",
    "depends_on": ["traits", "equipment"]
  }
}
```

### Язык Формул v1.0

Формулы представляют собой строки, состоящие из чисел, операторов и специальных функций-хелперов.

#### Операторы

На данный момент поддерживаются следующие бинарные операторы:
*   `+` (сложение)
*   `-` (вычитание)

#### Функции-хелперы

Функции используются для получения значений из различных частей модели персонажа.

1.  **`stat('stat_name')`**
    *   **Описание:** Получает значение числового параметра из `character.stats`.
    *   **Аргументы:**
        *   `stat_name` (string): Имя ключа в объекте `stats` (например, `'level'`, `'strength'`).
    *   **Возвращает:** `Number`. Если ключ не найден, возвращает `0`.
    *   **Пример:** `stat('level')`

2.  **`trait_meta('CategoryName', 'path.to.value')`**
    *   **Описание:** Получает значение из `metadata` трейта (`CharacterTrait`), выбранного персонажем.
    *   **Аргументы:**
        *   `CategoryName` (string): Имя категории трейта (например, `'Class'`, `'Ancestry'`). Поиск регистронезависимый.
        *   `path.to.value` (string): Путь к значению внутри JSON-объекта `metadata` трейта, разделенный точками.
    *   **Возвращает:** `Any`. Если трейт или путь не найден, возвращает `0` для числовых операций.
    *   **Пример:** `trait_meta('Class', 'base_hp')`

3.  **`equipment_meta('location', 'path.to.value')`**
    *   **Описание:** Получает значение из `metadata` предмета (`EquipmentTemplate`), который в данный момент экипирован персонажем в указанной локации.
    *   **Аргументы:**
        *   `location` (string): Локация предмета. Для v1.0 поддерживаем только `'armor'`.
        *   `path.to.value` (string): Путь к значению внутри `metadata` шаблона предмета.
    *   **Возвращает:** `Any`. Если предмет не экипирован или путь не найден, возвращает `0` для числовых операций.
    *   **Пример:** `equipment_meta('armor', 'evasion_penalty')`